<% url = Rails.application.routes.recognize_path(request.referrer) %>
<% if url[:action] != "search_category" %>
	<% if @item.subcategory != nil %>
		<%= link_to "Home", root_path %> -> <%= link_to Category.find(@item.category).name, search_category_items_path(Category.find(@item.category).name,1) %> -> 
		<%= link_to @subcategory.name, search_subcategory_path(Category.find(@item.category).name,@subcategory.name,1) %> -><%= @item.productTitle.slice(0..40) %>...
	<% else %>
		<%= link_to "Home", root_path %> -> <%= link_to Category.find(@item.category).name, search_category_items_path(Category.find(@item.category).name,1) %> -> <%= @item.productTitle.slice(0..40) %>...
	<% end %>
<% else %>
	<%= link_to "Home", root_path %> -> <%= link_to "Back", request.referrer %> -> <%= @item.productTitle.slice(0..40) %>...
<% end %>
<div class="container-fluid">
    <div class="content-wrapper">	
		<div class="item-container">	
			<div class="container">	
				<div class="col-md-12">
					<div class="product col-md-5 col-xs-12 service-image-left" style="height:100%;">
						<center>
							<%= image_tag @item.imageUrl, :class => "item-display" %><%# adding main product photo %>
						</center>
					</div>

					<div class="col-md-7">
						<div class="product-title">
							<%= simple_format(@item.productTitle) %>
						</div>

						<div class="product-rating">
							<%= render "/items/show/rating", :reviews => @ali_reviews %>
						</div>

						<hr>
						<div class="product-price"><%= @item.salePrice %>$ / <%= @item.packageType %> 
						<%= if @item.archived == "y" then ("<i class='fa fa-exclamation-triangle' style='color:red'> Price may be outdated</i>").html_safe else ("<i class='fa fa-exclamation-triangle' style='color:green'> Price up to date</i>").html_safe end %>
						</div>
						<div class="product-stock">In Stock</div>
						<hr>
						<%= link_to @item.promotionUrl do %>
						<div class="btn-group cart">
							<%= link_to aliexpress_pretty_url_path(@item.productId), :target => "_blank" do %>
								<button type="button" class="btn btn-success">
									Buy Now
								</button>
							<% end %>
						</div>
						<% end %>
						<div class="btn-group wishlist">
							<button type="button" class="btn btn-danger">
								Add To Cart
							</button>
						</div>
					</div>
				</div>
				<%= render "/layouts/ad" %>

				<%= render "/items/show/user_feedback" %>
					
				
			</div> 
		</div>
		<div class="container-fluid">		
			<div class="col-md-12 product-info">
					<ul id="myTab" class="nav nav-tabs nav_tabs">
						<% if @ali_reviews.length > 0 %>
							<li class="active"><a href="#reviews" data-toggle="tab">REVIEWS</a></li>
							<li><a href="#product-info" data-toggle="tab">PRODUCT INFO</a>
						<% else %>
							<li class="active"><a href="#product-info" data-toggle="tab">PRODUCT INFO</a></li>
							<li><a href="#reviews" data-toggle="tab">REVIEWS</a></li>
						<% end %>
						
					</ul>
				<div id="myTabContent" class="tab-content">

						<% if @ali_reviews.length > 0 %>
							<div class="tab-pane fade in" id="product-info">
						<% else %>
							<div class="tab-pane fade in active" id="product-info">
						<% end %>
						 
							<section class="col-xs-12 container product-info text-center">
								<%= print_multiline(@item.productDescription) %>
							</section>
										  
						</div>

						<% if @ali_reviews.length > 0 %>
							<div class="tab-pane fade in active" id="reviews">
						<% else %>
							<div class="tab-pane fade in" id="reviews">
						<% end %>
							<% if @review == nil %>
								<%= render "/items/show/call_to_action" %>
							<% else %>

							<% end %>
							<% i = 0 %><%# for making every review unique - without it javascript can't work %>
							<% @ali_reviews.each do |review| %>
								<%= render "/items/show/aliexpress_reviews", :review => review, :i => i %><%# sending item, i and user info to partial %>
								<% i = i + 1 %>
							<% end %>
						</div>
				</div>

				<hr>
			</div>
		</div>
	</div>
</div>

<%= render "best_items" %>

<%# start of google snippets %>
<% $brand = ActionView::Base.full_sanitizer.sanitize(@item.productDescription).split(" ") %>
<% $description = $brand %>
<% $index = $brand.index("Name:") %>

<script type="application/ld+json">
{
  "@context": "http://schema.org/",
  "@type": "Product",
  "name": "<%= @item.productTitle %>",
  "brand": "<%= if $index != nil then $brand[$index+1] else $brand = "Unknow" end %>",
  "image": "<%= @item.imageUrl %>",
  "description": "<%= $description.join(" ")[0..117] %>...",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "<%= @rate %>",
    "ratingCount": "<%= @rate_count %>"
  },
  "offers": {
    "@type": "Offer",
    "priceCurrency": "USD",
    "price": "<%= @item.salePrice %>",
    "priceValidUntil": "<%= @item.validTime %>",
    "itemCondition": "http://schema.org/NewCondition",
    "availability": "http://schema.org/InStock",
    "seller": {
      "@type": "Organization",
      "name": "Aliexpress"
    }
  }
}
</script>
<%# end of google snippets %>